<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#3B82F6" />
    <meta name="description" content="Simple group payment tracker for WhatsApp groups" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Dah Bayar" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192.svg" />
    <title>Dah Bayar - Simple Group Payment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 min-h-screen pb-20 transition-colors duration-200">
    <div x-data="paymentTracker()" class="max-w-md mx-auto pt-4 px-4">
      <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl p-4 mb-6 sticky top-4 z-10 transition-colors duration-200">
        <div class="flex justify-between items-center mb-2">
          <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold text-gray-800 dark:text-white">
              Dah Bayar?
            </h1>
            <button 
              @click="toggleDarkMode()" 
              class="p-1.5 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors"
            >
              <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
              <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
            <button 
              @click="showPaymentSettings = !showPaymentSettings"
              class="p-1.5 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors"
              title="Payment Settings"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
          </div>
          <button 
            @click="showInput = !showInput"
            class="text-blue-500 dark:text-blue-400 font-medium text-sm bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full active:bg-blue-100 dark:active:bg-blue-800 transition-colors"
          >
            <span x-text="showInput ? 'Close' : '+ New List'"></span>
          </button>
        </div>
        
        <div x-show="showInput" x-transition class="mt-4">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
            Paste WhatsApp message with participants list.
          </p>

          <textarea
            x-model="inputText"
            placeholder="Badminton 22/10/2025&#10;1. Zaki&#10;2. Fathur"
            class="w-full h-32 p-3 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
          ></textarea>

          <div class="mt-3">
            <label class="text-xs text-gray-600 dark:text-gray-400 mb-1 block">Amount Per Person (RM)</label>
            <input
              type="number"
              x-model="amountPerPerson"
              placeholder="10"
              step="0.10"
              min="0"
              class="w-full p-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
            />
          </div>

          <button
            @click="parseAndAdd"
            class="mt-3 w-full bg-blue-500 active:bg-blue-600 dark:bg-blue-600 dark:active:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg text-sm shadow-sm flex items-center justify-center gap-2"
          >
            <span>Add List</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          </button>
        </div>

        <!-- Payment Settings Panel -->
        <div x-show="showPaymentSettings" x-transition class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Payment Information</h3>
          
          <div class="space-y-3">
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 mb-1 block">Bank Name</label>
              <input
                type="text"
                x-model="paymentInfo.bankName"
                placeholder="e.g., Maybank, CIMB, Public Bank"
                class="w-full p-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
              />
            </div>
            
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 mb-1 block">Bank Account Number</label>
              <input
                type="text"
                x-model="paymentInfo.bankAccount"
                placeholder="e.g., 1234567890"
                class="w-full p-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
              />
            </div>
            
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 mb-1 block">Account Name</label>
              <input
                type="text"
                x-model="paymentInfo.bankAccountName"
                placeholder="e.g., John Doe"
                class="w-full p-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
              />
            </div>
            
            <div>
              <label class="text-xs text-gray-600 dark:text-gray-400 mb-1 block">Upload QR Image</label>
              <input
                type="file"
                accept="image/*"
                @change="handleQRUpload($event)"
                class="w-full p-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900/30 dark:file:text-blue-400"
              />
            </div>
            
            <div x-show="paymentInfo.qrCodeUrl" class="mt-2">
              <img :src="paymentInfo.qrCodeUrl" alt="QR Code Preview" class="w-32 h-32 object-contain border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 p-2" />
            </div>
            
            <button
              @click="savePaymentInfo"
              class="w-full bg-green-500 active:bg-green-600 dark:bg-green-600 dark:active:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm shadow-sm"
            >
              Save Payment Info
            </button>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <template x-for="list in lists" :key="list.id">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 transition-colors duration-200">
            <div class="flex justify-between items-start mb-4 gap-3">
              <button
                @click="confirmDelete(list.id)"
                class="text-gray-400 dark:text-gray-500 active:text-red-600 dark:active:text-red-400 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors flex-shrink-0"
                title="Delete"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
              <div class="flex-1 min-w-0">
                <h2
                  class="text-lg font-bold text-gray-800 dark:text-white break-words"
                  x-text="list.description"
                ></h2>
                <div class="flex items-center gap-2 mt-1">
                  <p
                    class="text-xs text-gray-500 dark:text-gray-400"
                    x-text="formatDate(list.createdAt)"
                  ></p>
                  <span x-show="list.amount" class="text-xs text-blue-600 dark:text-blue-400 font-semibold"
                    x-text="'RM ' + (list.amount ? list.amount.toFixed(2) : '')"></span>
                </div>
              </div>
              <div class="flex gap-1">
                <button
                  @click="shareQRCode(list)"
                  x-show="paymentInfo.qrCodeUrl"
                  class="text-gray-400 dark:text-gray-500 active:text-blue-600 dark:active:text-blue-400 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors"
                  title="Share QR Code"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 410.641 410.641"><path d="M113.574,123.494c5.522,0,10-4.477,10-10V10c0-5.523-4.478-10-10-10H10.078c-5.522,0-10,4.477-10,10v103.494c0,5.523,4.478,10,10,10H113.574z M20.078,20h83.496v83.494H20.078V20z"/><rect x="40.826" y="40.747" width="42" height="42"/><path d="M400.562,0H297.066c-5.522,0-10,4.477-10,10v103.494c0,5.523,4.478,10,10,10h103.496c5.521,0,10-4.477,10-10V10 C410.562,4.477,406.085,0,400.562,0z M390.562,103.494h-83.496V20h83.496V103.494z"/><rect x="327.814" y="40.747" width="42" height="42"/><path d="M400.562,287.146H297.066c-5.522,0-10,4.477-10,10v103.494c0,5.521,4.478,10,10,10h103.496c5.521,0,10-4.479,10-10 V297.146C410.562,291.623,406.085,287.146,400.562,287.146z M390.562,390.641h-83.496v-83.494h83.496V390.641z"/><rect x="327.814" y="327.893" width="42" height="42"/><path d="M62.078,294.186v-44.939h54.5c1.379,0,2.5-1.122,2.5-2.5v-47.439c0-1.378-1.121-2.5-2.5-2.5h-54.5v-44.939 c0-1.378-1.121-2.5-2.5-2.5h-57c-1.379,0-2.5,1.122-2.5,2.5v47.439c0,1.378,1.121,2.5,2.5,2.5h54.5v42.439h-54.5 c-1.379,0-2.5,1.121-2.5,2.5v47.439c0,1.377,1.121,2.5,2.5,2.5h57C60.958,296.686,62.078,295.564,62.078,294.186z"/><path d="M148.8,178.143c-1.379,0-2.5,1.122-2.5,2.5v55.232c0,1.378,1.121,2.5,2.5,2.5h55.232c1.379,0,2.5-1.122,2.5-2.5v-55.232 c0-1.378-1.121-2.5-2.5-2.5H148.8z"/><path d="M187.794,111.334h67.412c1.379,0,2.5-1.122,2.5-2.5V41.422c0-1.378-1.121-2.5-2.5-2.5h-67.412c-1.379,0-2.5,1.122-2.5,2.5 v67.412C185.294,110.212,186.416,111.334,187.794,111.334z"/><path d="M250.713,145.155v50.638c0,1.378,1.121,2.5,2.5,2.5h50.639c1.379,0,2.5-1.122,2.5-2.5v-50.638c0-1.378-1.121-2.5-2.5-2.5 h-50.639C251.834,142.655,250.713,143.777,250.713,145.155z"/><path d="M89.812,318.404H54.325c-1.379,0-2.5,1.123-2.5,2.5v32.988H2.578c-1.379,0-2.5,1.121-2.5,2.5v51.746 c0,1.379,1.121,2.5,2.5,2.5h51.747c1.379,0,2.5-1.121,2.5-2.5v-49.246h32.987c1.379,0,2.5-1.123,2.5-2.5v-35.488 C92.312,319.527,91.191,318.404,89.812,318.404z"/><path d="M267.083,282.918h-35.487c-1.379,0-2.5,1.122-2.5,2.5v32.986h-30.486v-32.986c0-1.378-1.121-2.5-2.5-2.5h-35.487 c-1.379,0-2.5,1.122-2.5,2.5v35.486c0,1.379,1.121,2.5,2.5,2.5h32.987v30.488h-49.247c-1.379,0-2.5,1.121-2.5,2.5v51.746 c0,1.379,1.121,2.5,2.5,2.5h51.747c1.379,0,2.5-1.121,2.5-2.5v-49.246h32.986c1.379,0,2.5-1.123,2.5-2.5v-32.988h32.987 c1.379,0,2.5-1.121,2.5-2.5v-35.486C269.583,284.04,268.462,282.918,267.083,282.918z"/><path d="M172.461,148.982v-35.487c0-1.378-1.121-2.5-2.5-2.5h-35.487c-1.378,0-2.5,1.122-2.5,2.5v35.487 c0,1.378,1.122,2.5,2.5,2.5h35.487C171.34,151.482,172.461,150.36,172.461,148.982z"/><path d="M186.787,37.987V2.5c0-1.378-1.121-2.5-2.5-2.5H148.8c-1.379,0-2.5,1.122-2.5,2.5v35.487c0,1.378,1.121,2.5,2.5,2.5 h35.486C185.667,40.487,186.787,39.366,186.787,37.987z"/><path d="M408.062,184.063c1.379,0,2.5-1.122,2.5-2.5v-35.487c0-1.378-1.121-2.5-2.5-2.5h-35.487c-1.379,0-2.5,1.122-2.5,2.5 v32.987h-32.987c-1.379,0-2.5,1.122-2.5,2.5v35.487c0,1.378,1.121,2.5,2.5,2.5h32.987v32.987c0,1.377,1.121,2.5,2.5,2.5h35.487 c1.379,0,2.5-1.123,2.5-2.5V217.05c0-1.378-1.121-2.5-2.5-2.5h-32.987v-30.487H408.062L408.062,184.063z"/></svg>
                </button>
                <button
                  @click="sharePaymentInfo(list)"
                  x-show="paymentInfo.bankAccount || paymentInfo.bankName || paymentInfo.bankAccountName"
                  class="text-gray-400 dark:text-gray-500 active:text-green-600 dark:active:text-green-400 p-2 rounded-full hover:bg-green-50 dark:hover:bg-green-900/30 transition-colors"
                  title="Share Payment Info"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="nonzero" d="M7.253 18.494l.724.423A7.953 7.953 0 0 0 12 20a8 8 0 1 0-8-8c0 1.436.377 2.813 1.084 4.024l.422.724-.653 2.401 2.4-.655zM2.004 22l1.352-4.968A9.954 9.954 0 0 1 2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10a9.954 9.954 0 0 1-5.03-1.355L2.004 22zM8.391 7.308c.134-.01.269-.01.403-.004.054.004.108.01.162.016.159.018.334.115.393.249.298.676.588 1.357.868 2.04.062.152.025.347-.093.537a4.38 4.38 0 0 1-.263.372c-.113.145-.356.411-.356.411s-.099.118-.061.265c.014.056.06.137.102.205l.059.095c.256.427.6.86 1.02 1.268.12.116.237.235.363.346.468.413.998.75 1.57 1l.005.002c.085.037.128.057.252.11.062.026.126.049.191.066a.35.35 0 0 0 .367-.13c.724-.877.79-.934.796-.934v.002a.482.482 0 0 1 .378-.127c.06.004.121.015.177.04.531.243 1.4.622 1.4.622l.582.261c.098.047.187.158.19.265.004.067.01.175-.013.373-.032.259-.11.57-.188.733a1.155 1.155 0 0 1-.21.302 2.378 2.378 0 0 1-.33.288 3.71 3.71 0 0 1-.125.09 5.024 5.024 0 0 1-.383.22 1.99 1.99 0 0 1-.833.23c-.185.01-.37.024-.556.014-.008 0-.568-.087-.568-.087a9.448 9.448 0 0 1-3.84-2.046c-.226-.199-.435-.413-.649-.626-.89-.885-1.562-1.84-1.97-2.742A3.47 3.47 0 0 1 6.9 9.62a2.729 2.729 0 0 1 .564-1.68c.073-.094.142-.192.261-.305.127-.12.207-.184.294-.228a.961.961 0 0 1 .371-.1z"/></svg>
                </button>
                <button
                  @click="toggleMinimized(list.id)"
                  class="text-gray-400 dark:text-gray-500 active:text-blue-600 dark:active:text-blue-400 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  :title="list.minimized ? 'Expand' : 'Minimize'"
                >
                  <svg x-show="!list.minimized" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                  <svg x-show="list.minimized" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
              </div>
            </div>

            <div x-show="!list.minimized" class="space-y-2">
              <!-- Grouped display -->
              <template x-if="list.groups">
                <div class="space-y-4">
                  <template x-for="group in list.groups" :key="group.name">
                    <div class="space-y-2">
                      <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide px-2 pt-2" x-text="group.name"></h3>
                      <template x-for="person in group.people" :key="person.name">
                        <label
                          class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg active:bg-gray-100 dark:active:bg-gray-600 cursor-pointer transition-colors"
                          :class="{'bg-green-50 dark:bg-green-900/20': person.paid}"
                        >
                          <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <input
                              type="checkbox"
                              :checked="person.paid"
                              @change="togglePaid(list.id, person.name, group.name)"
                              class="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                            />
                            <span
                              class="text-sm font-medium break-words"
                              :class="person.paid ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-200'"
                              x-text="person.name"
                            ></span>
                          </div>
                          <span
                            class="text-xs font-bold ml-3 flex-shrink-0"
                            :class="person.paid ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'"
                            x-text="person.paid ? '‚úì' : '‚óã'"
                          ></span>
                        </label>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
              
              <!-- Non-grouped display -->
              <template x-if="!list.groups">
                <div class="space-y-2">
                  <template x-for="person in list.people" :key="person.name">
                    <label
                      class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg active:bg-gray-100 dark:active:bg-gray-600 cursor-pointer transition-colors"
                      :class="{'bg-green-50 dark:bg-green-900/20': person.paid}"
                    >
                      <div class="flex items-center space-x-4 flex-1 min-w-0">
                        <input
                          type="checkbox"
                          :checked="person.paid"
                          @change="togglePaid(list.id, person.name)"
                          class="w-6 h-6 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                        />
                        <span
                          class="text-base font-medium break-words"
                          :class="person.paid ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-200'"
                          x-text="person.name"
                        ></span>
                      </div>
                      <span
                        class="text-sm font-bold ml-3 flex-shrink-0"
                        :class="person.paid ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'"
                        x-text="person.paid ? 'Paid' : 'Pending'"
                      ></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>

            <div x-show="!list.minimized" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600 dark:text-gray-400">Progress</span>
                <span class="font-bold text-gray-800 dark:text-gray-200">
                  <template x-if="list.groups">
                    <span>
                      <span x-text="list.groups.flatMap(g => g.people).filter(p => p.paid).length"></span>
                      / <span x-text="list.groups.flatMap(g => g.people).length"></span> paid
                    </span>
                  </template>
                  <template x-if="!list.groups">
                    <span>
                      <span x-text="list.people.filter(p => p.paid).length"></span>
                      / <span x-text="list.people.length"></span> paid
                    </span>
                  </template>
                </span>
              </div>
              <div x-show="list.amount" class="flex justify-between text-sm mb-2">
                <span class="text-gray-600 dark:text-gray-400">Amount Collected</span>
                <span class="font-bold text-green-600 dark:text-green-400">
                  <template x-if="list.groups">
                    <span x-text="'RM ' + (list.groups.flatMap(g => g.people).filter(p => p.paid).length * list.amount).toFixed(2) + ' / RM ' + (list.groups.flatMap(g => g.people).length * list.amount).toFixed(2)"></span>
                  </template>
                  <template x-if="!list.groups">
                    <span x-text="'RM ' + (list.people.filter(p => p.paid).length * list.amount).toFixed(2) + ' / RM ' + (list.people.length * list.amount).toFixed(2)"></span>
                  </template>
                </span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                <template x-if="list.groups">
                  <div
                    class="bg-green-500 h-3 rounded-full transition-all duration-300"
                    :style="`width: ${(list.groups.flatMap(g => g.people).filter(p => p.paid).length / list.groups.flatMap(g => g.people).length) * 100}%`"
                  ></div>
                </template>
                <template x-if="!list.groups">
                  <div
                    class="bg-green-500 h-3 rounded-full transition-all duration-300"
                    :style="`width: ${(list.people.filter(p => p.paid).length / list.people.length) * 100}%`"
                  ></div>
                </template>
              </div>
            </div>
          </div>
        </template>

        <div
          x-show="lists.length === 0"
          class="text-center py-16 px-4 text-gray-500 dark:text-gray-400"
        >
          <svg
            class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
            ></path>
          </svg>
          <p class="text-base">No payment lists yet</p>
          <p class="text-sm mt-1">Paste a WhatsApp message above to start</p>
        </div>
      </div>

      <!-- Disclaimer -->
      <div class="text-center px-4 py-4 text-xs text-gray-400 dark:text-gray-600">
        <div class="flex items-center justify-center gap-2">
          <p>üîí 100% of your data is stored securely on your device's local storage</p>
        </div>
      </div>

      <!-- Credit Footer -->
      <div class="text-center pb-8 px-4 text-xs text-gray-500 dark:text-gray-500">
        <p>Made with <span class="text-red-500">‚ù§</span> by <a href="https://www.facebook.com/cyberfly" target="_blank" rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">Muhammad Fathur Rahman</a></p>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2" style="max-width: 90vw; width: 360px;"></div>

    <script>
      function paymentTracker() {
        return {
          inputText: "",
          amountPerPerson: "",
          lists: [],
          showInput: false,
          darkMode: false,
          showPaymentSettings: false,
          paymentInfo: {
            bankName: "",
            bankAccount: "",
            bankAccountName: "",
            qrCodeUrl: ""
          },
          toasts: [],

          showToast(message, type = 'success') {
            const id = Date.now();
            const toast = { id, message, type };
            
            const container = document.getElementById('toast-container');
            const toastEl = document.createElement('div');
            toastEl.id = `toast-${id}`;
            toastEl.className = `transform transition-all duration-300 translate-x-full`;
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-gray-500';
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : type === 'info' ? '‚Ñπ' : '!';
            
            toastEl.innerHTML = `
              <div class="${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-start gap-3">
                <span class="text-lg font-bold flex-shrink-0">${icon}</span>
                <p class="text-sm flex-1">${message}</p>
                <button onclick="this.closest('[id^=toast-]').remove()" class="text-white hover:text-gray-200 flex-shrink-0">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
            `;
            
            container.appendChild(toastEl);
            
            setTimeout(() => {
              toastEl.classList.remove('translate-x-full');
            }, 10);
            
            setTimeout(() => {
              toastEl.classList.add('translate-x-full');
              setTimeout(() => toastEl.remove(), 300);
            }, 5000);
          },

          init() {
            const stored = JSON.parse(
              localStorage.getItem("paymentLists") || "[]"
            );
            this.lists = stored.map(list => ({ ...list, minimized: list.minimized || false }));
            
            this.darkMode = JSON.parse(localStorage.getItem('darkMode'));
            if (this.darkMode === null) {
                this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            if (this.darkMode) {
                document.documentElement.classList.add('dark');
            }

            // Load payment info
            const savedPaymentInfo = JSON.parse(localStorage.getItem('paymentInfo') || '{"bankName":"","bankAccount":"","bankAccountName":"","qrCodeUrl":""}');
            this.paymentInfo = savedPaymentInfo;
          },

          toggleDarkMode() {
            this.darkMode = !this.darkMode;
            localStorage.setItem('darkMode', this.darkMode);
            if (this.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
          },

          parseAndAdd() {
            if (!this.inputText.trim()) return;

            const lines = this.inputText
              .split("\n")
              .filter((line) => line.trim());
            const groups = [];
            let currentGroup = null;
            let description = "";

            lines.forEach((line) => {
              const groupMatch = line.match(/^group\s+(\d+|[a-zA-Z]+)/i);
              const personMatch = line.match(/^\s*(\d+)\.?\s*(.+)$/);
              
              if (groupMatch) {
                // Start a new group
                if (currentGroup && currentGroup.people.length > 0) {
                  groups.push(currentGroup);
                }
                currentGroup = {
                  name: line.trim(),
                  people: []
                };
              } else if (personMatch) {
                const name = personMatch[2].replace(/^[\s\u200B-\u200D\uFEFF\u00A0]+/, '').trim();
                if (name) {
                  if (currentGroup) {
                    currentGroup.people.push({ name: name, paid: false });
                  } else {
                    // No group defined yet, create default group
                    if (!currentGroup) {
                      currentGroup = { name: null, people: [] };
                    }
                    currentGroup.people.push({ name: name, paid: false });
                  }
                }
              } else if (!description && !groupMatch) {
                description = line.trim();
              }
            });

            // Add the last group
            if (currentGroup && currentGroup.people.length > 0) {
              groups.push(currentGroup);
            }

            if (groups.length > 0) {
              const hasMultipleGroups = groups.length > 1 || groups[0].name !== null;
              const newList = {
                id: Date.now(),
                description: description || "Payment List",
                amount: this.amountPerPerson ? parseFloat(this.amountPerPerson) : null,
                groups: hasMultipleGroups ? groups : null,
                people: hasMultipleGroups ? null : groups[0].people,
                createdAt: new Date().toISOString(),
                minimized: false,
              };

              this.lists.unshift(newList);
              this.save();
              this.inputText = "";
              this.amountPerPerson = "";
              this.showInput = false;
            }
          },

          togglePaid(listId, personName, groupName = null) {
            const list = this.lists.find((l) => l.id === listId);
            if (list) {
              if (list.groups) {
                const group = list.groups.find((g) => g.name === groupName);
                if (group) {
                  const person = group.people.find((p) => p.name === personName);
                  if (person) {
                    person.paid = !person.paid;
                    this.save();
                  }
                }
              } else {
                const person = list.people.find((p) => p.name === personName);
                if (person) {
                  person.paid = !person.paid;
                  this.save();
                }
              }
            }
          },

          toggleMinimized(listId) {
            const list = this.lists.find((l) => l.id === listId);
            if (list) {
              list.minimized = !list.minimized;
              this.save();
            }
          },

          confirmDelete(listId) {
            if (confirm('Are you sure you want to delete this list? This action cannot be undone.')) {
              this.deleteList(listId);
            }
          },

          deleteList(listId) {
            this.lists = this.lists.filter((l) => l.id !== listId);
            this.save();
          },

          save() {
            localStorage.setItem("paymentLists", JSON.stringify(this.lists));
          },

          formatDate(isoString) {
            return new Date(isoString).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          },

          savePaymentInfo() {
            localStorage.setItem('paymentInfo', JSON.stringify(this.paymentInfo));
            this.showToast('Payment information saved!', 'success');
            this.showPaymentSettings = false;
          },

          handleQRUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.paymentInfo.qrCodeUrl = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          },

          async urlToBlob(url) {
            try {
              const response = await fetch(url);
              return await response.blob();
            } catch (error) {
              console.error('Failed to convert URL to blob:', error);
              return null;
            }
          },

          buildPaymentMessage(list) {
            let message = `*Payment Info for: ${list.description}*\n`;
            
            if (list.amount) {
              message += `üí∞ Amount: RM ${list.amount.toFixed(2)}\n`;
            }
            
            message += `\n`;
            
            if (this.paymentInfo.bankName || this.paymentInfo.bankAccount || this.paymentInfo.bankAccountName) {
              message += `üí≥ Bank Account:\n`;
              if (this.paymentInfo.bankName) {
                message += `${this.paymentInfo.bankName}\n`;
              }
              if (this.paymentInfo.bankAccount) {
                message += `${this.paymentInfo.bankAccount}\n`;
              }
              if (this.paymentInfo.bankAccountName) {
                message += `${this.paymentInfo.bankAccountName}`;
              }
              message += `\n\n`;
            }
            
            // Get unpaid people
            let unpaidList = '';
            if (list.groups) {
              list.groups.forEach(group => {
                const unpaid = group.people.filter(p => !p.paid);
                if (unpaid.length > 0) {
                  unpaidList += `\n*${group.name}*\n`;
                  unpaid.forEach(p => unpaidList += `‚Ä¢ ${p.name}\n`);
                }
              });
            } else {
              const unpaid = list.people.filter(p => !p.paid);
              if (unpaid.length > 0) {
                unpaidList += '\n';
                unpaid.forEach(p => unpaidList += `‚Ä¢ ${p.name}\n`);
              }
            }
            
            if (unpaidList) {
              message += `‚è≥ *Pending Payment:*${unpaidList}`;
            }
            
            return message;
          },

          async shareQRCode(list) {
            if (!this.paymentInfo.qrCodeUrl) return;
            
            const message = this.buildPaymentMessage(list);
            
            const isAndroid = /android/i.test(navigator.userAgent);
            
            if (navigator.share && navigator.canShare) {
              try {
                const blob = await this.urlToBlob(this.paymentInfo.qrCodeUrl);
                
                if (blob) {
                  const file = new File([blob], "qr-code.png", { type: blob.type || "image/png" });
                  
                  if (navigator.canShare({ files: [file] })) {
                    // Always copy to clipboard for Android
                    if (isAndroid && navigator.clipboard) {
                      await navigator.clipboard.writeText(message);
                    }
                    
                    await navigator.share({
                      title: 'Payment QR Code',
                      text: isAndroid ? '' : message, // Empty text for Android
                      files: [file]
                    });
                    
                    // Notify Android users
                    if (isAndroid) {
                      setTimeout(() => {
                        this.showToast('üí° Payment details copied to clipboard! Paste them in your WhatsApp message.', 'info');
                      }, 300);
                    }
                    
                    return;
                  }
                }
              } catch (error) {
                console.log('Share failed:', error);
                this.showToast('Unable to share QR code. Please try again.', 'error');
              }
            } else {
              this.showToast('Sharing is not supported on this device/browser.', 'error');
            }
          },

          async sharePaymentInfo(list) {
            const message = this.buildPaymentMessage(list);
            
            // Share via WhatsApp (text only, no QR URL)
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
          },
        };
      }
    </script>
    
    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => console.log('SW registered:', registration))
            .catch(err => console.log('SW registration failed:', err));
        });
      }
    </script>
  </body>
</html>
