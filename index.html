<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Payment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 min-h-screen pb-20 transition-colors duration-200">
    <div x-data="paymentTracker()" class="max-w-md mx-auto pt-4 px-4">
      <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl p-4 mb-6 sticky top-4 z-10 transition-colors duration-200">
        <div class="flex justify-between items-center mb-2">
          <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold text-gray-800 dark:text-white">
              Dah Bayar?
            </h1>
            <button 
              @click="toggleDarkMode()" 
              class="p-1.5 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors"
            >
              <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
              <svg x-show="darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
          </div>
          <button 
            @click="showInput = !showInput"
            class="text-blue-500 dark:text-blue-400 font-medium text-sm bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full active:bg-blue-100 dark:active:bg-blue-800 transition-colors"
          >
            <span x-text="showInput ? 'Close' : '+ New List'"></span>
          </button>
        </div>
        
        <div x-show="showInput" x-transition class="mt-4">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
            Paste WhatsApp message with participants list.
          </p>

          <textarea
            x-model="inputText"
            placeholder="Badminton 22/10/2025&#10;1. John&#10;2. Doe"
            class="w-full h-32 p-3 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
          ></textarea>

          <button
            @click="parseAndAdd"
            class="mt-3 w-full bg-blue-500 active:bg-blue-600 dark:bg-blue-600 dark:active:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg text-sm shadow-sm flex items-center justify-center gap-2"
          >
            <span>Add List</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          </button>
        </div>
      </div>

      <div class="space-y-4">
        <template x-for="list in lists" :key="list.id">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 transition-colors duration-200">
            <div class="flex justify-between items-start mb-4 gap-3">
              <div class="flex-1 min-w-0">
                <h2
                  class="text-lg font-bold text-gray-800 dark:text-white break-words"
                  x-text="list.description"
                ></h2>
                <p
                  class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                  x-text="formatDate(list.createdAt)"
                ></p>
              </div>
              <div class="flex gap-1">
                <button
                  @click="toggleMinimized(list.id)"
                  class="text-gray-400 dark:text-gray-500 active:text-blue-600 dark:active:text-blue-400 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  :title="list.minimized ? 'Expand' : 'Minimize'"
                >
                  <svg x-show="!list.minimized" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                  <svg x-show="list.minimized" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <button
                  @click="deleteList(list.id)"
                  class="text-gray-400 dark:text-gray-500 active:text-red-600 dark:active:text-red-400 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors"
                  title="Delete"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
              </div>
            </div>

            <div x-show="!list.minimized" class="space-y-2">
              <!-- Grouped display -->
              <template x-if="list.groups">
                <div class="space-y-4">
                  <template x-for="group in list.groups" :key="group.name">
                    <div class="space-y-2">
                      <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide px-2 pt-2" x-text="group.name"></h3>
                      <template x-for="person in group.people" :key="person.name">
                        <label
                          class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg active:bg-gray-100 dark:active:bg-gray-600 cursor-pointer transition-colors"
                          :class="{'bg-green-50 dark:bg-green-900/20': person.paid}"
                        >
                          <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <input
                              type="checkbox"
                              :checked="person.paid"
                              @change="togglePaid(list.id, person.name, group.name)"
                              class="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                            />
                            <span
                              class="text-sm font-medium break-words"
                              :class="person.paid ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-200'"
                              x-text="person.name"
                            ></span>
                          </div>
                          <span
                            class="text-xs font-bold ml-3 flex-shrink-0"
                            :class="person.paid ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'"
                            x-text="person.paid ? '✓' : '○'"
                          ></span>
                        </label>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
              
              <!-- Non-grouped display -->
              <template x-if="!list.groups">
                <div class="space-y-2">
                  <template x-for="person in list.people" :key="person.name">
                    <label
                      class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg active:bg-gray-100 dark:active:bg-gray-600 cursor-pointer transition-colors"
                      :class="{'bg-green-50 dark:bg-green-900/20': person.paid}"
                    >
                      <div class="flex items-center space-x-4 flex-1 min-w-0">
                        <input
                          type="checkbox"
                          :checked="person.paid"
                          @change="togglePaid(list.id, person.name)"
                          class="w-6 h-6 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                        />
                        <span
                          class="text-base font-medium break-words"
                          :class="person.paid ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-800 dark:text-gray-200'"
                          x-text="person.name"
                        ></span>
                      </div>
                      <span
                        class="text-sm font-bold ml-3 flex-shrink-0"
                        :class="person.paid ? 'text-green-600 dark:text-green-400' : 'text-orange-500 dark:text-orange-400'"
                        x-text="person.paid ? 'Paid' : 'Pending'"
                      ></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>

            <div x-show="!list.minimized" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600 dark:text-gray-400">Progress</span>
                <span class="font-bold text-gray-800 dark:text-gray-200">
                  <template x-if="list.groups">
                    <span>
                      <span x-text="list.groups.flatMap(g => g.people).filter(p => p.paid).length"></span>
                      / <span x-text="list.groups.flatMap(g => g.people).length"></span> paid
                    </span>
                  </template>
                  <template x-if="!list.groups">
                    <span>
                      <span x-text="list.people.filter(p => p.paid).length"></span>
                      / <span x-text="list.people.length"></span> paid
                    </span>
                  </template>
                </span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                <template x-if="list.groups">
                  <div
                    class="bg-green-500 h-3 rounded-full transition-all duration-300"
                    :style="`width: ${(list.groups.flatMap(g => g.people).filter(p => p.paid).length / list.groups.flatMap(g => g.people).length) * 100}%`"
                  ></div>
                </template>
                <template x-if="!list.groups">
                  <div
                    class="bg-green-500 h-3 rounded-full transition-all duration-300"
                    :style="`width: ${(list.people.filter(p => p.paid).length / list.people.length) * 100}%`"
                  ></div>
                </template>
              </div>
            </div>
          </div>
        </template>

        <div
          x-show="lists.length === 0"
          class="text-center py-16 px-4 text-gray-500 dark:text-gray-400"
        >
          <svg
            class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
            ></path>
          </svg>
          <p class="text-base">No payment lists yet</p>
          <p class="text-sm mt-1">Paste a WhatsApp message above to start</p>
        </div>
      </div>
    </div>

    <script>
      function paymentTracker() {
        return {
          inputText: "",
          lists: [],
          showInput: false,
          darkMode: false,

          init() {
            const stored = JSON.parse(
              localStorage.getItem("paymentLists") || "[]"
            );
            this.lists = stored.map(list => ({ ...list, minimized: list.minimized || false }));
            
            this.darkMode = JSON.parse(localStorage.getItem('darkMode'));
            if (this.darkMode === null) {
                this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            if (this.darkMode) {
                document.documentElement.classList.add('dark');
            }
          },

          toggleDarkMode() {
            this.darkMode = !this.darkMode;
            localStorage.setItem('darkMode', this.darkMode);
            if (this.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
          },

          parseAndAdd() {
            if (!this.inputText.trim()) return;

            const lines = this.inputText
              .split("\n")
              .filter((line) => line.trim());
            const groups = [];
            let currentGroup = null;
            let description = "";

            lines.forEach((line) => {
              const groupMatch = line.match(/^group\s+(\d+|[a-zA-Z]+)/i);
              const personMatch = line.match(/^\s*(\d+)\.?\s*(.+)$/);
              
              if (groupMatch) {
                // Start a new group
                if (currentGroup && currentGroup.people.length > 0) {
                  groups.push(currentGroup);
                }
                currentGroup = {
                  name: line.trim(),
                  people: []
                };
              } else if (personMatch) {
                const name = personMatch[2].replace(/^[\s\u200B-\u200D\uFEFF\u00A0]+/, '').trim();
                if (name) {
                  if (currentGroup) {
                    currentGroup.people.push({ name: name, paid: false });
                  } else {
                    // No group defined yet, create default group
                    if (!currentGroup) {
                      currentGroup = { name: null, people: [] };
                    }
                    currentGroup.people.push({ name: name, paid: false });
                  }
                }
              } else if (!description && !groupMatch) {
                description = line.trim();
              }
            });

            // Add the last group
            if (currentGroup && currentGroup.people.length > 0) {
              groups.push(currentGroup);
            }

            if (groups.length > 0) {
              const hasMultipleGroups = groups.length > 1 || groups[0].name !== null;
              const newList = {
                id: Date.now(),
                description: description || "Payment List",
                groups: hasMultipleGroups ? groups : null,
                people: hasMultipleGroups ? null : groups[0].people,
                createdAt: new Date().toISOString(),
                minimized: false,
              };

              this.lists.unshift(newList);
              this.save();
              this.inputText = "";
              this.showInput = false;
            }
          },

          togglePaid(listId, personName, groupName = null) {
            const list = this.lists.find((l) => l.id === listId);
            if (list) {
              if (list.groups) {
                const group = list.groups.find((g) => g.name === groupName);
                if (group) {
                  const person = group.people.find((p) => p.name === personName);
                  if (person) {
                    person.paid = !person.paid;
                    this.save();
                  }
                }
              } else {
                const person = list.people.find((p) => p.name === personName);
                if (person) {
                  person.paid = !person.paid;
                  this.save();
                }
              }
            }
          },

          toggleMinimized(listId) {
            const list = this.lists.find((l) => l.id === listId);
            if (list) {
              list.minimized = !list.minimized;
              this.save();
            }
          },

          deleteList(listId) {
            this.lists = this.lists.filter((l) => l.id !== listId);
            this.save();
          },

          save() {
            localStorage.setItem("paymentLists", JSON.stringify(this.lists));
          },

          formatDate(isoString) {
            return new Date(isoString).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
          },
        };
      }
    </script>
  </body>
</html>
